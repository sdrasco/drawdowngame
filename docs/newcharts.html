<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drawdown - D3 Demo</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    #marketChartMobile {
      display: block;
      width: 100%;
      height: auto;
      aspect-ratio: 600 / 350;
      background: #000;
    }

    .mobile-chart {
      display: none;
    }

    @media (max-width: 600px) {
      .desktop-chart {
        display: none;
      }
      .mobile-chart {
        display: block;
      }
    }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <div id="status" class="status">
    <div>Week: <span id="week">14</span>/<span id="maxWeek">104</span></div>
    <div>Net Worth: $<span id="netWorth">35000</span></div>
    <div>Rank: <span id="rank">Novice</span></div>
    <div>Cash: $<span id="cash">35000</span></div>
  </div>
  <div class="chart-wrapper desktop-chart">
    <div id="marketChart"></div>
  </div>
  <div class="chart-wrapper mobile-chart">
    <div id="marketChartMobile"></div>
  </div>
  <div id="news" class="news">
    <div class="headline">Apple unveils breakthrough wearable tech.</div>
    <div class="headline">Tesla stock surges after record deliveries.</div>
    <div class="headline">Oil prices fall as supply concerns ease.</div>
    <div class="headline">Global markets rally on strong economic data.</div>
  </div>
  <div class="menu">
    <button id="dataBtn">Analysis</button>
    <button id="portfolioBtn">Portfolio</button>
    <button id="tradeBtn" onclick="location.href='trade.html'">Trade</button>
    <button id="doneBtn" class="advance">Advance to Next Week</button>
    <button id="cashOutBtn">Retire</button>
  </div>
  <div id="username" class="username"></div>
  <div id="usernamePrompt" class="username-prompt hidden">
    <form>
      <label for="usernameInput">Enter a username</label><br/>
      <input id="usernameInput" type="text" autocomplete="off" /><br/>
      <button type="button" id="usernameSubmit">Start</button>
      <button type="button" id="usernameRandom">Random Name</button>
    </form>
  </div>
  <div id="scorePrompt" class="username-prompt hidden">
    <form>
      <label for="scoreInput">High score name</label><br/>
      <input id="scoreInput" type="text" autocomplete="off" /><br/>
      <button type="button" id="scoreSubmit">Save</button>
      <button type="button" id="scoreRandom">Random Name</button>
    </form>
  </div>
  <div id="gameOverDialog" class="username-prompt hidden">
    <form>
      <p>Game over.</p>
      <p class="final-worth">Final Net Worth: $<span id="gameOverNetWorth"></span></p>
      <button type="button" id="gameOverAdmire">Admire Your Game</button>
      <button type="button" id="gameOverScores">High Scores</button>
      <button type="button" id="gameOverNew">Start New Game</button>
      <button type="button" id="gameOverMenu">Main Menu</button>
    </form>
  </div>
  <script>
    // sample data for demonstration
    const weeks = Array.from({ length: 52 }, (_, i) => i + 1);
    const indexPct = weeks.map(w => Math.sin(w / 5) * 5 + w * 0.2);
    const portfolioPct = weeks.map(w => Math.sin(w / 6) * 6 + w * 0.2 + 2);

    function drawChart(id) {
      const container = d3.select(`#${id}`);
      container.selectAll('*').remove();
      const width = container.node().clientWidth;
      const height = width * 350 / 600;
      const margin = { top: 20, right: 20, bottom: 40, left: 40 };
      const svg = container.append('svg')
        .attr('width', width)
        .attr('height', height);
      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;
      const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
      const x = d3.scaleLinear()
        .domain(d3.extent(weeks))
        .range([0, chartWidth]);
      const y = d3.scaleLinear()
        .domain([
          d3.min(indexPct.concat(portfolioPct)),
          d3.max(indexPct.concat(portfolioPct))
        ])
        .nice()
        .range([chartHeight, 0]);
      const line = d3.line()
        .x((d, i) => x(weeks[i]))
        .y(d => y(d))
        .curve(d3.curveMonotoneX);

      svg.style('touch-action', 'none');

      const clipId = `clip-${id}`;
      svg.append('defs').append('clipPath')
        .attr('id', clipId)
        .append('rect')
        .attr('width', chartWidth)
        .attr('height', chartHeight);

      const plot = g.append('g')
        .attr('clip-path', `url(#${clipId})`);

      const indexPath = plot.append('path')
        .datum(indexPct)
        .attr('class', 'index-line')
        .attr('fill', 'none')
        .attr('stroke', '#39ff14')
        .attr('stroke-width', 2)
        .attr('d', line);
      const portfolioPath = plot.append('path')
        .datum(portfolioPct)
        .attr('class', 'portfolio-line')
        .attr('fill', 'none')
        .attr('stroke', '#ff8c00')
        .attr('stroke-width', 2)
        .attr('d', line);

      const xAxis = g.append('g')
        .attr('class', 'x-axis')
        .attr('transform', `translate(0,${chartHeight})`)
        .call(d3.axisBottom(x).ticks(10));
      g.append('g')
        .attr('class', 'y-axis')
        .call(d3.axisLeft(y).ticks(5).tickFormat(d => d + '%'));
      g.append('text')
        .attr('x', chartWidth / 2)
        .attr('y', chartHeight + margin.bottom - 5)
        .attr('text-anchor', 'middle')
        .attr('fill', '#33ff33')
        .text('Week');

      // dotted zero line
      plot.append('line')
        .attr('x1', 0)
        .attr('x2', chartWidth)
        .attr('y1', y(0))
        .attr('y2', y(0))
        .attr('stroke', '#777')
        .attr('stroke-dasharray', '3 3');
      const legendWidth = 120;
      const legend = svg.append('g')
        .attr('transform', `translate(${(width - legendWidth) / 2},10)`);
      legend.append('line')
        .attr('x1', 0).attr('y1', 0)
        .attr('x2', 20).attr('y2', 0)
        .attr('stroke', '#39ff14')
        .attr('stroke-width', 2);
      legend.append('text')
        .attr('x', 24).attr('y', 0)
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#33ff33')
        .text('Index');
      legend.append('line')
        .attr('x1', 80).attr('y1', 0)
        .attr('x2', 100).attr('y2', 0)
        .attr('stroke', '#ff8c00')
        .attr('stroke-width', 2);
      legend.append('text')
        .attr('x', 104).attr('y', 0)
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#33ff33')
        .text('Portfolio');

      const zoom = d3.zoom()
        .scaleExtent([1, 10])
        .translateExtent([[0, 0], [chartWidth, chartHeight]])
        .extent([[0, 0], [chartWidth, chartHeight]])
        .on('zoom', event => {
          const newX = event.transform.rescaleX(x);
          xAxis.call(d3.axisBottom(newX).ticks(10));
          indexPath.attr('d',
            d3.line()
              .x((d, i) => newX(weeks[i]))
              .y(d => y(d))
              .curve(d3.curveMonotoneX)
          );
          portfolioPath.attr('d',
            d3.line()
              .x((d, i) => newX(weeks[i]))
              .y(d => y(d))
              .curve(d3.curveMonotoneX)
          );
        });

      svg.call(zoom);
    }

    function render() {
      drawChart('marketChart');
      drawChart('marketChartMobile');
    }
    window.addEventListener('resize', render);
    render();
  </script>
</body>
</html>
